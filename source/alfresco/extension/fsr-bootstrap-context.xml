<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:aop="http://www.springframework.org/schema/aop"
xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">

    <bean id="schemaBootstrap" class="org.alfresco.repo.transfer.fsr.SchemaBootstrap" init-method="init">
       <property name="dataSource">
          <ref bean="dataSource"/>
       </property>
       <property name="creationScript">
          <value>classpath:org/alfresco/repo/transfer/fsr/Create-Fsr-Tables.sql</value>
       </property>
    </bean>

    <bean id="dataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
            <property name="driverClassName"><value>org.apache.derby.jdbc.EmbeddedDriver</value></property>
            <property name="url"><value>jdbc:derby:/home/philippe/DEV_FSR/SDK342/samples/FSR/derbyDB;create=true;user=alfresco;password=alfresco</value></property>
            <property name="poolPreparedStatements"><value>false</value></property>
            <property name="maxActive"><value>5</value></property>
            <property name="maxIdle"><value>5</value></property>
            <property name="maxWait"><value>40000</value></property>
            <property name="removeAbandoned"><value>true</value></property>
            <property name="removeAbandonedTimeout"><value>300</value></property>
            <property name="logAbandoned"><value>false</value></property>
    </bean>

    <bean id="transactionAwaredataSource" class="org.springframework.jdbc.datasource.TransactionAwareDataSourceProxy">
        <property name="targetDataSource">
            <ref local="dataSource"/>
        </property>
     </bean>


    <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="transactionSynchronizationName">
            <value>SYNCHRONIZATION_ALWAYS</value>
        </property>
        <property name="dataSource">
            <ref bean="transactionAwaredataSource" />
        </property>
    </bean>

    <bean id="transactionService" class="org.alfresco.repo.transfer.fsr.FileTransferReceiverTransactionServiceImpl">
        <property name="transactionManager">
            <ref bean="transactionManager" />
        </property>
        <!-- property name="authenticationContext">
            <ref bean="authenticationContext" />
        </property -->
        <!-- property name="sysAdminParams">
            <ref bean="sysAdminParams"/>
        </property -->
        <property name="allowWrite">
            <value>true</value>
        </property>
        <property name="maxRetries">
            <value>40</value>
        </property>
        <property name="minRetryWaitMs">
            <value>100</value>
        </property>
        <property name="maxRetryWaitMs">
            <value>2000</value>
        </property>
        <property name="retryWaitIncrementMs">
            <value>100</value>
        </property>
    </bean>

    <bean id="retryingTransactionHelper" class="org.alfresco.repo.transaction.RetryingTransactionHelper">
        <property name="transactionService">
            <ref bean="transactionService"/>
        </property>
        <property name="maxRetries">
            <value>40</value>
        </property>
        <property name="minRetryWaitMs">
            <value>100</value>
        </property>
        <property name="maxRetryWaitMs">
            <value>2000</value>
        </property>
        <property name="retryWaitIncrementMs">
            <value>100</value>
        </property>
    </bean>

    <!-- Clustered (DB) locking Service -->
    <bean id="jobLockService" class="org.alfresco.repo.lock.JobLockServiceImpl">
        <property name="retryingTransactionHelper">
            <bean class="org.alfresco.repo.transaction.RetryingTransactionHelper">
                <property name="transactionService">
                    <ref bean="transactionService"/>
                </property>
                <property name="maxRetries">
                    <value>10</value>
                </property>
                <property name="minRetryWaitMs">
                    <value>10</value>
                </property>
                <property name="maxRetryWaitMs">
                    <value>10</value>
                </property>
                <property name="retryWaitIncrementMs">
                    <value>1</value>
                </property>
            </bean>
        </property>
        <property name="lockDAO" ref="lockDAO" />
        <property name="defaultRetryCount"><value>10</value></property>
        <property name="defaultRetryWait"><value>20</value></property>
    </bean>

   <bean id="lockDAO" class="org.alfresco.repo.domain.locks.ibatis.LockDAOImpl">
      <property name="sqlMapClientTemplate" ref="locksSqlMapClientTemplate"/>
      <property name="qnameDAO" ref="qnameDAO"/>
   </bean>

   <bean id="locksSqlMapClientTemplate" class="org.springframework.orm.ibatis.SqlMapClientTemplate">
        <property name="sqlMapClient" ref="sqlMapClient"/>
   </bean>

   <bean id="qnameDAO" class="org.alfresco.repo.domain.qname.ibatis.QNameDAOImpl">
      <property name="sqlMapClientTemplate" ref="ftrSqlMapClientTemplate"/>
      <property name="namespaceCache" ref="immutableEntityCache"/>
      <property name="qnameCache" ref="immutableEntityCache"/>
   </bean>

   <!-- The transactional cache for immutable entities -->
   <bean name="immutableEntityCache" class="org.alfresco.repo.cache.NullCache">
   </bean>

   <bean id="mapConfig" class="org.springframework.core.io.ClassPathResource">
        <constructor-arg>
            <value>org/alfresco/repo/transfer/fsr/FTR-SqlMapConfig.xml</value>
        </constructor-arg>
   </bean>

    <bean id="ftrSqlMapClientTemplate" class="org.springframework.orm.ibatis.SqlMapClientTemplate">
        <property name="sqlMapClient" ref="sqlMapClient"/>
    </bean>

    <bean id="sqlMapClient" class="org.springframework.orm.ibatis.SqlMapClientFactoryBean">
        <property name="dataSource" ref="transactionAwaredataSource" />
        <property name="configLocation" ref="mapConfig" />
    </bean>

    <bean id="transferVersionChecker" class="org.alfresco.repo.transfer.TransferVersionCheckerImpl">
    </bean>

    <bean id="transferReceiver" class="org.alfresco.repo.transfer.fsr.FileTransferReceiver">
        <property name="transactionService" ref="transactionService" />
        <property name="jobLockService" ref="jobLockService" />
        <property name="lockRefreshTime">
            <value>60000</value>
        </property>
        <property name="lockRetryCount">
            <value>3</value>
        </property>
        <property name="lockRetryWait">
            <value>100</value>
        </property>
        <property name="lockTimeOut">
            <value>300000</value>
        </property>
        <property name="transferVersionChecker">
            <ref bean="transferVersionChecker" />
        </property>
        <property name="rootStagingDirectory">
                <value>/home/philippe/DEV_FSR/SDK342/samples/FSR/stagingdirectory</value>
        </property>
        <property name="defaultReceivingroot">
                <value>/home/philippe/DEV_FSR/SDK342/samples/FSR/receivingRoot</value>
        </property>
        <property name="manifestProcessorFactory" ref="fTransferManifestProcessorFactory" />
        <property name="progressMonitor" ref="transferProgressMonitor" />
    </bean>

    <bean id="fTransferManifestProcessorFactory" class="org.alfresco.repo.transfer.fsr.FileTransferManifestProcessorFactory"/>

    <bean id="transferProgressMonitor"
        class="org.alfresco.repo.transfer.LoggingTransferProgressMonitorImpl">
        <property name="delegate">
            <bean class="org.alfresco.repo.transfer.fsr.FileTransferProgressMonitor">

            </bean>
        </property>
    </bean>


</beans>